name: SCA - Dependency Security Scan

# DÃ©clenchement du workflow
on:
  push:
    branches:
      - '**'
  pull_request:
    branches:
      - master
  schedule:
    # Scan quotidien Ã  2h00 UTC
    - cron: '0 2 * * *'

jobs:
  npm-audit:
    name: NPM Audit
    runs-on: ubuntu-latest
    
    steps:
      # Ã‰tape 1 : RÃ©cupÃ©ration du code
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      # Ã‰tape 2 : Configuration de Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      # Ã‰tape 3 : Installation des dÃ©pendances
      - name: Install Dependencies
        run: npm ci
      
      # Ã‰tape 4 : Audit NPM des vulnÃ©rabilitÃ©s
      - name: Run NPM Audit
        id: npm-audit
        run: |
          echo "ğŸ” Lancement de l'audit npm..."
          
          # Audit complet avec gÃ©nÃ©ration du rapport JSON
          npm audit --json > npm-audit-report.json || true
          
          # Audit avec niveau de sÃ©vÃ©ritÃ© (bloque si critical)
          npm audit --audit-level=critical
        continue-on-error: false  # Bloque si vulnÃ©rabilitÃ©s critiques
      
      # Ã‰tape 5 : Analyse dÃ©taillÃ©e des vulnÃ©rabilitÃ©s
      - name: Analyze Vulnerabilities
        if: always()
        run: |
          echo "ğŸ“Š Analyse des vulnÃ©rabilitÃ©s dÃ©tectÃ©es..."
          
          # Compter les vulnÃ©rabilitÃ©s par niveau
          CRITICAL=$(npm audit --json | jq '.metadata.vulnerabilities.critical // 0')
          HIGH=$(npm audit --json | jq '.metadata.vulnerabilities.high // 0')
          MODERATE=$(npm audit --json | jq '.metadata.vulnerabilities.moderate // 0')
          LOW=$(npm audit --json | jq '.metadata.vulnerabilities.low // 0')
          
          echo "ğŸ”´ Critical: $CRITICAL"
          echo "ğŸŸ  High: $HIGH"
          echo "ğŸŸ¡ Moderate: $MODERATE"
          echo "ğŸŸ¢ Low: $LOW"
          
          # Ã‰chec si vulnÃ©rabilitÃ©s critiques
          if [ "$CRITICAL" -gt 0 ]; then
            echo "âŒ Ã‰CHEC: Des vulnÃ©rabilitÃ©s CRITICAL ont Ã©tÃ© dÃ©tectÃ©es!"
            echo "ğŸ”’ Le merge est BLOQUÃ‰ jusqu'Ã  rÃ©solution."
            exit 1
          fi
      
      # Ã‰tape 6 : Upload du rapport
      - name: Upload Audit Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: npm-audit-report
          path: npm-audit-report.json
          retention-days: 30
      
      # Ã‰tape 7 : Commentaire sur PR avec rÃ©sumÃ©
      - name: Comment PR with Audit Results
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let auditData;
            
            try {
              auditData = JSON.parse(fs.readFileSync('npm-audit-report.json', 'utf8'));
            } catch (error) {
              console.log('Pas de rapport npm audit disponible');
              return;
            }
            
            const critical = auditData.metadata.vulnerabilities.critical || 0;
            const high = auditData.metadata.vulnerabilities.high || 0;
            const moderate = auditData.metadata.vulnerabilities.moderate || 0;
            const low = auditData.metadata.vulnerabilities.low || 0;
            const total = critical + high + moderate + low;
            
            let status = 'âœ…';
            let message = 'Aucune vulnÃ©rabilitÃ© critique dÃ©tectÃ©e.';
            
            if (critical > 0) {
              status = 'âŒ';
              message = `**${critical} vulnÃ©rabilitÃ©(s) CRITIQUE(S) dÃ©tectÃ©e(s) !**\n\nğŸ”’ **Le merge est BLOQUÃ‰** jusqu'Ã  rÃ©solution.`;
            } else if (high > 0) {
              status = 'âš ï¸';
              message = `${high} vulnÃ©rabilitÃ©(s) HIGH dÃ©tectÃ©e(s). Correction recommandÃ©e.`;
            }
            
            const comment = `${status} **Analyse SCA (npm audit) terminÃ©e**\n\n` +
                           `**RÃ©sumÃ© des vulnÃ©rabilitÃ©s :**\n` +
                           `- ğŸ”´ Critical: ${critical}\n` +
                           `- ğŸŸ  High: ${high}\n` +
                           `- ğŸŸ¡ Moderate: ${moderate}\n` +
                           `- ğŸŸ¢ Low: ${low}\n` +
                           `- **Total: ${total}**\n\n` +
                           `${message}\n\n` +
                           `ğŸ“„ Le rapport complet est disponible dans les artifacts.`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  # Job sÃ©parÃ© pour Dependabot (surveillance continue)
  dependabot-check:
    name: Check Dependabot Alerts
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      security-events: read
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Check Dependabot Status
        run: |
          echo "ğŸ“¦ Dependabot est configurÃ© pour surveiller les dÃ©pendances"
          echo "ğŸ”” Les alertes seront crÃ©Ã©es automatiquement dans l'onglet Security"
          echo "ğŸ¤– Dependabot crÃ©era des PR automatiques pour les mises Ã  jour de sÃ©curitÃ©"
